---
title: "Linear Mixed Model Analysis Report"
author: ""
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "data/output/"
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 6
)
```

# Introduction

This report presents the results of a linear mixed-effects model analysis examining the relationship between memory scores and other variables on participant scores.

# Setup and Data Loading

## Load Required Libraries

```{r libraries}
library(lme4)
library(lmerTest)
library(emmeans)
library(multcomp)
library(quantreg)
```

## Load and Prepare Data

```{r data-loading}
# Read data
df <- read.csv("data/input/final_data_order_all.csv")

# Convert categorical variables to factors
#df$participant <- factor(df$participant)
#df$type <- factor(df$type)
#df$image_id <- factor(df$image_id)

# Convert categorical variables to factors with explicit reference levels
df$participant <- factor(df$participant)
df$type <- factor(df$type, levels = c("cake","donut","sandwich","wine"))
df$image_id <- factor(df$image_id)
df$memory_score <- factor(df$memory_score, levels = c("high","low"))
df$quality <- factor(df$quality, levels = c("低质量","中质量","高质量"))
df$attract <- factor(df$attract, levels = c("无区别","无吸引力","有吸引力"))
df$mood <- factor(df$mood, levels = c("非常负面","负面","中立","正面","非常正面"))


# Display data structure
str(df)
```

```{r data-summary}
# Summary statistics
summary(df)
```

# Linear Mixed-Effects Model

## Model Specification

We fit a linear mixed-effects model with:

- **Fixed effects**: memory_score, type, quality, attract, image_memory_order, food_order, mood, and the interaction between memory_score and type
- **Random effects**: Random intercept and random slope for memory_score by participant

```{r lmer-model}
m_lmer <- lmer(
  score ~ memory_score * type +
    quality + attract + image_memory_order + food_order + mood +
    (1 + memory_score | participant),
  data = df,
  REML = TRUE
)
```

## Model Summary

```{r model-summary}
summary(m_lmer)
```

## Confidence Intervals

```{r confidence-intervals}
confint(m_lmer, method = "Wald")
```

# ANOVA Analysis

## Type III ANOVA (lmerTest)

```{r anova-analysis}
anova_lmerTest <- anova(m_lmer)
print("=== lmerTest ANOVA Results ===")
print(anova_lmerTest)
```

# Post-hoc Analysis

## Estimated Marginal Means

```{r emmeans}
emm_type <- emmeans(m_lmer, ~ memory_score)
print(emm_type)
```

## Pairwise Comparisons (Tukey)

```{r tukey-pairs}
pairs_tukey <- pairs(emm_type, adjust = "tukey")
print(pairs_tukey)
```

## Effect Sizes

```{r effect-sizes}
eff_tukey <- eff_size(emm_type, sigma = sigma(m_lmer), edf = df.residual(m_lmer))
print(eff_tukey)
```
## Conventional Paired Cohen's d

The model-based d above uses the LME residual SD as the denominator (emmeans::eff_size).
Below we compute the conventional paired-samples Cohen's d = mean(within-subject differences) / SD(within-subject differences).

```{r conventional-paired-d}
# Compute within-participant paired WTP differences (high - low memorability)
# Each participant has one score per memorability level per food type,
# so we pivot to wide format and subtract.

df_wide <- reshape(
  df[, c("participant", "memory_score", "type", "score")],
  idvar = c("participant", "type"),
  timevar = "memory_score",
  v.names = "score",
  direction = "wide"
)

# Within-participant difference per category (high - low)
df_wide$diff <- df_wide$score.high - df_wide$score.low

# Overall paired d: average the 4 category diffs per participant, then compute d
participant_mean_diff <- tapply(df_wide$diff, df_wide$participant, mean)
paired_d_overall <- mean(participant_mean_diff) / sd(participant_mean_diff)

cat("=== Conventional Paired Cohen's d (per-participant average across categories) ===\n")
cat(sprintf("  Mean within-participant diff = %.3f\n", mean(participant_mean_diff)))
cat(sprintf("  SD of within-participant diffs = %.3f\n", sd(participant_mean_diff)))
cat(sprintf("  Paired d = %.3f\n\n", paired_d_overall))

# Per-category paired d
cat("=== Per-category Paired Cohen's d ===\n")
for (tp in levels(df$type)) {
  diffs_cat <- df_wide$diff[df_wide$type == tp]
  d_cat <- mean(diffs_cat) / sd(diffs_cat)
  cat(sprintf("  %s: mean diff = %.3f, SD = %.3f, paired d = %.3f\n",
              tp, mean(diffs_cat), sd(diffs_cat), d_cat))
}
```
# Quantile Regression

## Median Regression (τ = 0.5)

```{r quantile-regression}
formula <- score ~ memory_score * type + quality + attract + image_memory_order + food_order + mood

quant_model_median <- rq(formula, tau = 0.5, data = df)
set.seed(123)
summary(quant_model_median, se = "boot", R = 1000)
```

