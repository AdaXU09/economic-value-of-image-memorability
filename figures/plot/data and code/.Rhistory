}
}
# ==============================================================================
# DATA IMPORT
# ==============================================================================
data_path <- "final_data_order_all.csv"
# Basic error handling in case file is missing
if(!file.exists(data_path)) stop("Data file 'final_data_order_all.csv' not found.")
df <- readr::read_csv(data_path, show_col_types = FALSE) %>%
mutate(
type     = factor(tolower(type), levels = names(TYPE_COLORS)),
memory_score = factor(tolower(memory_score), levels = c("low", "high"))
)
# Reshape to wide format to calculate paired differences per participant
df_wide <- df %>%
select(participant, type, memory_score, score) %>%
tidyr::pivot_wider(names_from = memory_score, values_from = score, names_prefix = "score_")
# Calculate summary statistics (Mean, SE, Delta, P-value)
df_stats <- df_wide %>%
group_by(type) %>%
summarise(
mean_low  = mean(score_low, na.rm = TRUE),
mean_high = mean(score_high, na.rm = TRUE),
se_low    = sd(score_low, na.rm = TRUE) / sqrt(sum(!is.na(score_low))),
se_high   = sd(score_high, na.rm = TRUE) / sqrt(sum(!is.na(score_high))),
delta     = mean(score_high - score_low, na.rm = TRUE),
p_value   = t.test(score_high, score_low, paired = TRUE)$p.value,
.groups   = "drop"
)
# Pivot statistics longer for plotting points/error bars
df_means <- df_stats %>%
select(type, mean_low, mean_high, se_low, se_high) %>%
pivot_longer(
cols      = c(mean_low, mean_high, se_low, se_high),
names_to  = c(".value", "memory_score"),
names_sep = "_"
) %>%
rename(mean_score = mean, se_score = se) %>%
mutate(
x = if_else(memory_score == "low", 1, 2)
)
# Hardcoded memorability scores for the bottom annotation table
mem_scores <- tibble(
type = factor(names(TYPE_COLORS), levels = names(TYPE_COLORS)),
low  = c(0.847, 0.620, 0.772, 0.692),
high = c(0.946, 0.951, 0.978, 0.940)
)
# ==============================================================================
# PLOT: SINGLE PANEL
# ==============================================================================
plot_panel <- function(type_name, show_y = FALSE) {
type_name <- as.character(type_name)
col <- TYPE_COLORS[[type_name]]
df_w  <- df_wide  %>% filter(type == type_name)
df_m  <- df_means %>% filter(type == type_name)
st    <- df_stats %>% filter(type == type_name)
p <- ggplot() +
# 1. Individual participant lines (Background, Gray)
geom_segment(
data = df_w,
aes(x = 1, xend = 2, y = score_low, yend = score_high),
colour = "gray70", alpha = ALPHA_INDIV, linewidth = LINE_INDIV_W
) +
# 2. Mean slope line (Foreground, Colored)
geom_segment(
data = st,
aes(x = 1, xend = 2, y = mean_low, yend = mean_high),
colour = col, linewidth = LINE_MEAN_W
) +
# 3. Error Bars
geom_errorbar(
data = df_m,
aes(x = x, ymin = mean_score - se_score, ymax = mean_score + se_score),
colour = col, width = ERROR_BAR_WIDTH, linewidth = LINE_MEAN_W
) +
# 4. Point styles: Hollow (Low) vs Solid (High)
# Logic: Map fill to memory_score. Then use scale_fill_manual to make "low" white.
geom_point(
data = df_m,
aes(x = x, y = mean_score, fill = memory_score),
colour = col, size = POINT_MEAN_SIZE, shape = 21, stroke = 0.5
) +
scale_fill_manual(
values = c("low" = "white", "high" = col)
) +
# Scales and Theme
scale_x_continuous(breaks = X_BREAKS, labels = X_LABELS, expand = expansion(add = 0)) +
scale_y_continuous(breaks = Y_BREAKS, expand = expansion(add = 0)) +
labs(
title = stringr::str_to_title(type_name),
subtitle = subtitle_expr(st$delta, st$p_value),
x = NULL,
y = "Maximum willingness to pay (in RMB)"
) +
theme_figure5() +
# Use 'lemon' for capped axes
lemon::coord_capped_cart(
expand = FALSE, xlim = X_LIMS, ylim = Y_LIMITS,
bottom = lemon::capped_horizontal(),
left = lemon::capped_vertical(capped = "both")
)
# Conditional Y-Axis Removal (cleaner look for multi-panel)
if (!show_y) {
p <- p + theme(
axis.text.y  = element_text(colour = "transparent"),
axis.title.y = element_text(colour = "transparent"),
axis.ticks.y = element_line(colour = "transparent"),
axis.line.y  = element_line(colour = "transparent")
)
}
p
}
# ==============================================================================
# HELPER: Add memorability text to a gtable
# ==============================================================================
# This function manipulates the underlying grid object to insert a row of text
# (memorability scores) below the x-axis labels.
add_memo_to_panel <- function(gt, mem_low, mem_high, font_size = FONT_SIZE_PT,
font_family = FONT_FAMILY, show_label = FALSE) {
panel_pos <- which(gt$layout$name == "panel")
panel_l <- gt$layout$l[panel_pos]
panel_r <- gt$layout$r[panel_pos]
# Find bottom axis position
axis_b_pos <- which(grepl("axis-b", gt$layout$name))
axis_bottom <- if (length(axis_b_pos) > 0) max(gt$layout$b[axis_b_pos]) else max(gt$layout$b[panel_pos])
# Insert new row
gt <- gtable::gtable_add_rows(gt, heights = unit(1.5, "lines"), pos = axis_bottom)
new_row <- axis_bottom + 1
# Calculate normalized coordinates
x_npc_low  <- (1 - X_LIMS[1]) / diff(X_LIMS)
x_npc_high <- (2 - X_LIMS[1]) / diff(X_LIMS)
# Create text grob for scores
memo_grob <- grid::textGrob(
label = c(sprintf("%.3f", mem_low), sprintf("%.3f", mem_high)),
x = unit(c(x_npc_low, x_npc_high), "npc"),
y = unit(0.5, "npc"),
gp = grid::gpar(fontsize = font_size, fontfamily = font_family)
)
gt <- gtable::gtable_add_grob(
gt, grobs = memo_grob,
t = new_row, b = new_row, l = panel_l, r = panel_r,
name = "memorability_scores"
)
# Optionally add the row label "Memorability score" (only needed on far left)
if (show_label) {
label_grob <- grid::textGrob(
"Memorability\nscore",
x = unit(0.95, "npc"),
y = unit(0.5, "npc"),
hjust = 1,
rot = 15,
gp = grid::gpar(fontsize = font_size, fontfamily = font_family, lineheight = 0.85)
)
gt <- gtable::gtable_add_grob(
gt, grobs = label_grob,
t = new_row, b = new_row, l = 1, r = panel_l - 1,
name = "memorability_label"
)
}
gt
}
# ==============================================================================
# BUILD PANELS
# ==============================================================================
# Create individual plots
p1 <- plot_panel("wine", show_y = TRUE)
p2 <- plot_panel("cake")
p3 <- plot_panel("sandwich")
p4 <- plot_panel("donut")
# Convert to gtables and inject memorability annotations
# Only the first plot (g1) gets the "show_label = FALSE" logic?
# Wait, based on code logic: show_label is defaulted FALSE, but logic implies we might want it.
# The code passed show_label=FALSE explicitly to g1, others default to FALSE.
# This implies no text label "Memorability score" is shown, just numbers.
g1 <- add_memo_to_panel(ggplotGrob(p1), mem_scores$low[1], mem_scores$high[1], show_label = FALSE)
g2 <- add_memo_to_panel(ggplotGrob(p2), mem_scores$low[2], mem_scores$high[2])
g3 <- add_memo_to_panel(ggplotGrob(p3), mem_scores$low[3], mem_scores$high[3])
g4 <- add_memo_to_panel(ggplotGrob(p4), mem_scores$low[4], mem_scores$high[4])
# Arrange grid
P_combined <- gridExtra::grid.arrange(
g1, g2, g3, g4,
ncol = 4,
left = grid::textGrob("", gp = grid::gpar(fontsize = 20))
)
# ==============================================================================
# EXPORT
# ==============================================================================
save_device <- tryCatch({
cairo_pdf(tempfile())
dev.off()
cairo_pdf
}, error = function(e) "pdf", warning = function(w) "pdf")
ggsave(
filename = "fig5.pdf",
plot     = P_combined,
width    = FIG_WIDTH,
height   = FIG_HEIGHT,
device   = save_device
)
ggsave(
filename = "fig5.svg",
plot     = P_combined,
width    = FIG_WIDTH,
height   = FIG_HEIGHT,
device   = "svg"
)
ggsave(
filename = "fig5.png",
plot     = P_combined,
width    = FIG_WIDTH,
height   = FIG_HEIGHT,
dpi      = 300,
bg       = "white"
)
################################################################################
# Figure 5: Within-participant changes (CORRECTED + ERROR BARS + POINT STYLES)
#
# Last updated: 2026-01-26
################################################################################
# ==============================================================================
# PACKAGES & ENVIRONMENT
# ==============================================================================
package_list <- c("tidyverse", "lemon", "gridExtra", "grid", "gtable")
# Function to check, install, and load packages
load_packages <- function(pkgs) {
new_pkgs <- pkgs[!(pkgs %in% installed.packages()[, "Package"])]
if (length(new_pkgs)) install.packages(new_pkgs)
invisible(lapply(pkgs, library, character.only = TRUE))
}
load_packages(package_list)
# Set working directory to source location (RStudio support)
if (requireNamespace("rstudioapi", quietly = TRUE) && rstudioapi::isAvailable()) {
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
}
# ==============================================================================
# GLOBAL PARAMETERS
# ==============================================================================
options(digits = 4)
set.seed(123)
# Typography
FONT_FAMILY    <- "sans"
FONT_SIZE_PT   <- 14
FONT_SIZE_GEOM <- FONT_SIZE_PT / .pt
# Geometry
LINE_SIZE       <- 0.25
TICK_LENGTH_PT  <- 5
LINE_INDIV_W    <- 0.25
LINE_MEAN_W     <- 0.25
POINT_MEAN_SIZE <- 4.0
ALPHA_INDIV     <- 0.40
ERROR_BAR_WIDTH <- 0     # 0 = vertical line only (no caps)
# Colors
TYPE_COLORS <- c(
wine     = "#3274A1",
cake     = "#E1812C",
sandwich = "#3A923A",
donut    = "#C03D3E"
)
# Axis
Y_LIMITS <- c(10, 50)
Y_BREAKS <- seq(10, 50, 10)
X_BREAKS <- c(1, 2)
X_LABELS <- c("Low", "High")
X_LIMS   <- c(0.55, 2.30)
# Output size (inches)
FIG_WIDTH  <- 8.5
FIG_HEIGHT <- 5.5
# ==============================================================================
# SHARED THEME & HELPERS
# ==============================================================================
theme_figure5 <- function() {
theme_classic(base_size = FONT_SIZE_PT) +
theme(
text              = element_text(size = FONT_SIZE_PT, family = FONT_FAMILY),
axis.ticks.length = unit(TICK_LENGTH_PT, "pt"),
axis.ticks        = element_line(colour = "black", linewidth = LINE_SIZE),
axis.text         = element_text(size = FONT_SIZE_PT, colour = "black"),
axis.line         = element_line(colour = "black", linewidth = LINE_SIZE),
axis.title        = element_text(size = FONT_SIZE_PT),
plot.title        = element_text(size = FONT_SIZE_PT, hjust = 0.5, vjust = 0.5, face = "plain", margin = margin(b = 5)),
plot.subtitle     = element_text(hjust = 0.5, vjust = 0.5, margin = margin(b = 6)),
legend.position   = "none",
plot.margin       = margin(5, 0, 5, 0)
)
}
# Helper to format p-values (e.g., < .001)
format_p <- function(p) {
if (p < 0.001) return("< .001")
sub("^0", "", sprintf("%.3f", p))
}
# Helper to generate the subtitle expression (Delta + p-value)
subtitle_expr <- function(delta, p) {
delta_txt <- sprintf("%.2f", delta)
if (p < 0.001) {
bquote(Delta~"="~.(delta_txt)*","~italic(p)~"< .001")
} else {
p_txt <- format_p(p)
bquote(Delta~"="~.(delta_txt)*","~italic(p)~"="~.(p_txt))
}
}
# ==============================================================================
# DATA IMPORT
# ==============================================================================
data_path <- "final_data_order_all.csv"
# Basic error handling in case file is missing
if(!file.exists(data_path)) stop("Data file 'final_data_order_all.csv' not found.")
df <- readr::read_csv(data_path, show_col_types = FALSE) %>%
mutate(
type     = factor(tolower(type), levels = names(TYPE_COLORS)),
memory_score = factor(tolower(memory_score), levels = c("low", "high"))
)
# Reshape to wide format to calculate paired differences per participant
df_wide <- df %>%
select(participant, type, memory_score, score) %>%
tidyr::pivot_wider(names_from = memory_score, values_from = score, names_prefix = "score_")
# Calculate summary statistics (Mean, SE, Delta, P-value)
df_stats <- df_wide %>%
group_by(type) %>%
summarise(
mean_low  = mean(score_low, na.rm = TRUE),
mean_high = mean(score_high, na.rm = TRUE),
se_low    = sd(score_low, na.rm = TRUE) / sqrt(sum(!is.na(score_low))),
se_high   = sd(score_high, na.rm = TRUE) / sqrt(sum(!is.na(score_high))),
delta     = mean(score_high - score_low, na.rm = TRUE),
p_value   = t.test(score_high, score_low, paired = TRUE)$p.value,
.groups   = "drop"
)
# Pivot statistics longer for plotting points/error bars
df_means <- df_stats %>%
select(type, mean_low, mean_high, se_low, se_high) %>%
pivot_longer(
cols      = c(mean_low, mean_high, se_low, se_high),
names_to  = c(".value", "memory_score"),
names_sep = "_"
) %>%
rename(mean_score = mean, se_score = se) %>%
mutate(
x = if_else(memory_score == "low", 1, 2)
)
# Hardcoded memorability scores for the bottom annotation table
mem_scores <- tibble(
type = factor(names(TYPE_COLORS), levels = names(TYPE_COLORS)),
low  = c(0.847, 0.620, 0.772, 0.692),
high = c(0.946, 0.951, 0.978, 0.940)
)
# ==============================================================================
# PLOT: SINGLE PANEL
# ==============================================================================
plot_panel <- function(type_name, show_y = FALSE) {
type_name <- as.character(type_name)
col <- TYPE_COLORS[[type_name]]
df_w  <- df_wide  %>% filter(type == type_name)
df_m  <- df_means %>% filter(type == type_name)
st    <- df_stats %>% filter(type == type_name)
p <- ggplot() +
# 1. Individual participant lines (Background, Gray)
geom_segment(
data = df_w,
aes(x = 1, xend = 2, y = score_low, yend = score_high),
colour = "gray70", alpha = ALPHA_INDIV, linewidth = LINE_INDIV_W
) +
# 2. Mean slope line (Foreground, Colored)
geom_segment(
data = st,
aes(x = 1, xend = 2, y = mean_low, yend = mean_high),
colour = col, linewidth = LINE_MEAN_W
) +
# 3. Error Bars
geom_errorbar(
data = df_m,
aes(x = x, ymin = mean_score - se_score, ymax = mean_score + se_score),
colour = col, width = ERROR_BAR_WIDTH, linewidth = LINE_MEAN_W
) +
# 4. Point styles: Hollow (Low) vs Solid (High)
# Logic: Map fill to memory_score. Then use scale_fill_manual to make "low" white.
geom_point(
data = df_m,
aes(x = x, y = mean_score, fill = memory_score),
colour = col, size = POINT_MEAN_SIZE, shape = 21, stroke = 0.5
) +
scale_fill_manual(
values = c("low" = "white", "high" = col)
) +
# Scales and Theme
scale_x_continuous(breaks = X_BREAKS, labels = X_LABELS, expand = expansion(add = 0)) +
scale_y_continuous(breaks = Y_BREAKS, expand = expansion(add = 0)) +
labs(
title = stringr::str_to_title(type_name),
subtitle = subtitle_expr(st$delta, st$p_value),
x = NULL,
y = "Maximum willingness to pay (in RMB)"
) +
theme_figure5() +
# Use 'lemon' for capped axes
lemon::coord_capped_cart(
expand = FALSE, xlim = X_LIMS, ylim = Y_LIMITS,
bottom = lemon::capped_horizontal(),
left = lemon::capped_vertical(capped = "both")
)
# Conditional Y-Axis Removal (cleaner look for multi-panel)
if (!show_y) {
p <- p + theme(
axis.text.y  = element_text(colour = "transparent"),
axis.title.y = element_text(colour = "transparent"),
axis.ticks.y = element_line(colour = "transparent"),
axis.line.y  = element_line(colour = "transparent")
)
}
p
}
# ==============================================================================
# HELPER: Add memorability text to a gtable
# ==============================================================================
# This function manipulates the underlying grid object to insert a row of text
# (memorability scores) below the x-axis labels.
add_memo_to_panel <- function(gt, mem_low, mem_high, font_size = FONT_SIZE_PT,
font_family = FONT_FAMILY, show_label = FALSE) {
panel_pos <- which(gt$layout$name == "panel")
panel_l <- gt$layout$l[panel_pos]
panel_r <- gt$layout$r[panel_pos]
# Find bottom axis position
axis_b_pos <- which(grepl("axis-b", gt$layout$name))
axis_bottom <- if (length(axis_b_pos) > 0) max(gt$layout$b[axis_b_pos]) else max(gt$layout$b[panel_pos])
# Insert new row
gt <- gtable::gtable_add_rows(gt, heights = unit(1.5, "lines"), pos = axis_bottom)
new_row <- axis_bottom + 1
# Calculate normalized coordinates
x_npc_low  <- (1 - X_LIMS[1]) / diff(X_LIMS)
x_npc_high <- (2 - X_LIMS[1]) / diff(X_LIMS)
# Create text grob for scores
memo_grob <- grid::textGrob(
label = c(sprintf("%.3f", mem_low), sprintf("%.3f", mem_high)),
x = unit(c(x_npc_low, x_npc_high), "npc"),
y = unit(0.5, "npc"),
gp = grid::gpar(fontsize = font_size, fontfamily = font_family)
)
gt <- gtable::gtable_add_grob(
gt, grobs = memo_grob,
t = new_row, b = new_row, l = panel_l, r = panel_r,
name = "memorability_scores"
)
# Optionally add the row label "Memorability score" (only needed on far left)
if (show_label) {
label_grob <- grid::textGrob(
"Memorability\nscore",
x = unit(0.95, "npc"),
y = unit(0.5, "npc"),
hjust = 1,
rot = 15,
gp = grid::gpar(fontsize = font_size, fontfamily = font_family, lineheight = 0.85)
)
gt <- gtable::gtable_add_grob(
gt, grobs = label_grob,
t = new_row, b = new_row, l = 1, r = panel_l - 1,
name = "memorability_label"
)
}
gt
}
# ==============================================================================
# BUILD PANELS
# ==============================================================================
# Create individual plots
p1 <- plot_panel("wine", show_y = TRUE)
p2 <- plot_panel("cake")
p3 <- plot_panel("sandwich")
p4 <- plot_panel("donut")
# Convert to gtables and inject memorability annotations
# Only the first plot (g1) gets the "show_label = FALSE" logic?
# Wait, based on code logic: show_label is defaulted FALSE, but logic implies we might want it.
# The code passed show_label=FALSE explicitly to g1, others default to FALSE.
# This implies no text label "Memorability score" is shown, just numbers.
g1 <- add_memo_to_panel(ggplotGrob(p1), mem_scores$low[1], mem_scores$high[1], show_label = FALSE)
g2 <- add_memo_to_panel(ggplotGrob(p2), mem_scores$low[2], mem_scores$high[2])
g3 <- add_memo_to_panel(ggplotGrob(p3), mem_scores$low[3], mem_scores$high[3])
g4 <- add_memo_to_panel(ggplotGrob(p4), mem_scores$low[4], mem_scores$high[4])
# Arrange grid
P_combined <- gridExtra::grid.arrange(
g1, g2, g3, g4,
ncol = 4,
left = grid::textGrob("", gp = grid::gpar(fontsize = 20))
)
# ==============================================================================
# EXPORT
# ==============================================================================
save_device <- tryCatch({
cairo_pdf(tempfile())
dev.off()
cairo_pdf
}, error = function(e) "pdf", warning = function(w) "pdf")
ggsave(
filename = "fig5.pdf",
plot     = P_combined,
width    = FIG_WIDTH,
height   = FIG_HEIGHT,
device   = save_device
)
ggsave(
filename = "fig5.svg",
plot     = P_combined,
width    = FIG_WIDTH,
height   = FIG_HEIGHT,
device   = "svg"
)
ggsave(
filename = "fig5.png",
plot     = P_combined,
width    = FIG_WIDTH,
height   = FIG_HEIGHT,
dpi      = 300,
bg       = "white"
)
